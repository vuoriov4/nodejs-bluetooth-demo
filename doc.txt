<h1>How to communicate across Linux devices with Bluetooth and NodeJS</h1>

<p>
	Some background: I have a project that's using a Raspberry Pi to control a circuit.
	I want to communicate with it remotely through my laptop.
	I couldn't find a good example on how to do it with NodeJS, so I decided to write this.
</p>
<p>
	The aim of this tutorial is to create two things.
	1. A NodeJS program that broadcasts bluetooth data from a client (my laptop) to a target device (Raspberry PI).
	2. Another NodeJS program inside the target device that listens for bluetooth data (and reacts to it).
	I'll try to keep things as simple as possible.
</p>


<h2>Okay, let's get started!</h2>

<p>
	The first thing to do is to make sure both your client- and target device have bluetooth up and running.
	After running <code class="code-inline">sudo service bluetooth status</code>
	you should see something like "Status: Running". If not... you should try to turn on bluetooth.
	Assuming it's running you can find the bluetooth address by running <code class="code-inline">hcitool dev</code>.
	It should look something like <code class="code-inline">00:C2:C6:7C:60:31</code>.
	Write the address of your target device. You'll need it later.
</p>
<p>
	Let's install <a href="https://github.com/eelcocramer/node-bluetooth-serial-port">bluetooth-serial-port</a>.
	It's a NodeJS wrapper for bluetooth.
	<code class="code-inline">sudo apt-get install build-essential libbluetooth-dev</code>
	<code class="code-inline">sudo npm install bluetooth-serial-port</code>
	 Don't forget to install these on your target device aswell.
</p>
<h1>The server</h1>
<pre><code class="language-js">const server = new(require('bluetooth-serial-port')).BluetoothSerialPortServer();
const TARGET_CHANNEL = 1;
const TARGET_UUID = '7a379a32-63ce-449d-b71a-40f4e6616458';
console.log("Listening for bluetooth connections...");
server.listen(function (clientAddress) {
    console.log('Client ' + clientAddress + ' connected.');
    server.on('data', function(buffer) {
        console.log('Received message: "' + buffer + '"');
        server.write(new Buffer('Thanks for the message!'), function(error) {
            console.error(error)
        });
    });
}, function(error){
	console.error(error);
}, {uuid: TARGET_UUID, channel: TARGET_CHANNEL} );
</code></pre>
</p>
<h1>The client</h1>
<p>
const btSerial = new (require('bluetooth-serial-port')).BluetoothSerialPort();
const TARGET_ADDRESS = "B8:27:EB:D1:4E:7A"; // Replace with bluetooth address of your target device.
const TARGET_CHANNEL = 1;
console.log('Connecting to ' + TARGET_ADDRESS + "...");
process.stdin.resume();
process.stdin.setEncoding('utf8');
btSerial.connect(TARGET_ADDRESS, TARGET_CHANNEL, function() {
    console.log("Connected!");
    btSerial.write(new Buffer("Hello world!", 'utf-8'), function(err, count) {
        if (err) console.error(err);
    });
    btSerial.on('data', function(data) {
        console.log(data.toString('utf-8'));
    });
}, function (err) {
    if (err) console.error(err);
});
</p>
<h1>Troubleshooting</h1>
<p>
	Right off the bat I got an error along the lines of "Can't connect to SDP Daemon".
	I fixed it by changing the bluetooth service to run in compatibility mode, like this:
	Run <code class="code-inline">sudo nano /etc/systemd/system/dbus-org.bluez.service</code> and change the line
	<code class="code-inline">ExecStart=/usr/lib/bluetooth/bluetoothd</code>
	to <code class="code-inline">ExecStart=/usr/lib/bluetooth/bluetoothd --compat</code>.
	Then restart bluetooth like this
	<code class="code-inline">sudo systemctl daemon-reload && sudo systemctl restart bluetooth</code>.
</p>
<p>
	My client still couldn't pick up the server, but after struggling with it for a while I managed to fix it like this:
	In your target device, run <code class="code-inline">bluetoothctl</code>, then type <code class="code-inline">power on</code> and <code class="code-inline">discoverable on</code>.
	Exit the shell by typing <code class="code-inline">exit</code> and then run the server again.
</p>
<p>
	One last thing, make sure to run the client- and server scripts with <code class="code-inline">sudo</code>.
	As a last resort, try rebooting the target device. Good luck!
</p>
</p>
